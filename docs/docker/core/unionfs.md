![Docker](/docker/docker.png)

# Docker 核心技术：Union File System

大家好，我是费益洲。UnionFS 作为 Docker 的技术核心之一，实现了 Docker 镜像的分层轻量化构建、容器资源的隔离复用等目的。本文将从核心原理、主流技术实现、容器技术中的应用三个方面简单介绍 UnionFS。

## 核心原理

Linux 的联合文件系统（Union File System，简称 UnionFS）是一种将多个目录层（Layer）“透明地”叠加为单一视图的文件系统的技术。

UnionFS 叠加的过程其实是 UnionFS 将多个目录层（Layer）联合挂载到了同一个挂载点，并进行目录层内容的覆盖。用户最终看到的是一个合并后的文件系统，但实际上文件内容可能分布在不同的存储位置。当用户在最终合并完成后的文件系统写入内容时，系统是真正将内容写入了新的文件，但是这个过程并不会改变原来的文件，这是因为 UnionFS 还用到了另外一个重要的资源管理技术，写时复制。

### 分层存储

层（Layer）：层是 UnionFS 的基本组成单元，每一层都包含文件系统的一部分内容，多个层联合叠加后，共同组成一个完整的文件系统。层一般分为只读层和读写层：

只读层（Read-Only Layer）：

- 可能有多个只读层，每个只读层的内容都是固定不变的
- 每个只读层都包含一部分系统需要的库或者二进制文件等基础文件
- 相同的只读层只会在物理存储中存在一个，但是可以被多个容器共享
- 多个只读层之间有上下层关系，上层可以覆盖下层的同名文件夹和文件

读写层（Read-Write Layer）：

- 在容器技术中，读写层都是记录容器在运行过程中的内容修改
- 每个容器在运行时都会有独立的读写层，这种设计解决了容器运行时的文件内容隔离
- 在容器被删除时，该容器的读写层也会被删除

### 写时复制

写时复制机制（Copy-on-Write），即只有在需要写入（修改）时，才会进行复制操作，然后操作复制出来的副本。这种机制可以节省大量的存储空间和时间，而且不会修改原始文件。整体的工作流程如下所示：

1. 读操作流程：系统从上层到下层依次查找文件，找到文件后直接读取，无额外开销
2. 首次写入（修改）流程：

   ![Docker](/docker/core/cow.png)

3. 后续写入（修改）流程：无需再次复制，直接修改读写层中已经存在的副本

## 主流实现技术

UnionFS 的主流实现技术有： ​​AUFS​、​​OverlayFS、​​Device Mapper​​、Btrfs/ZFS 等。AUFS 是一个用户空间的联合文件系统实现，设计目标是提供最大的灵活性和功能完整性，AUFS 是早期 Docker 的默认存储驱动。Device Mapper 不是传统意义上的文件系统，而是 Linux 内核的一个框架，用于将物理块设备映射为虚拟块设备。Btrfs 和 ZFS 都是现代文件系统，原生支持快照和子卷功能。

Docker 目前默认使用 OverlayFS 作为默认的存储系统，Docker 从早期的 AUFS 转向 OverlayFS，是综合了内核兼容性、性能、资源利用率及社区生态等多方面因素的结果：

💻 1.内核兼容性

- AUFS 未被内核主线接纳
  AUFS 作为第三方文件系统，​​ 从未被集成到 Linux 内核主线 ​​，需用户手动为内核打补丁并重新编译，导致兼容性差。尤其在 RedHat/CentOS 等强调稳定性的发行版中无法直接使用

- 内核原生支持 OverlayFS
  自 Linux 内核版本 3.18 起，OverlayFS 直接集成到内核主线 ​​，无需额外补丁，到 4.0 版本以后，就支持了所有功能。

⚡ 2.性能

- OverlayFS​​ 的 CoW 操作是块级（Block-level）​​，复制单位是文件的数据块。AUFS​​ 的 CoW 操作是文件级（File-level）​​，复制单位是整个文件，对大文件操作延迟显著

📦 3.资源利用率

- OverlayFS（overlay2） 通过符号链接管理层间依赖，避免 inode 耗尽问题。AUFS 则依赖硬链接，易导致 inode 枯竭（尤其在频繁创建/销毁容器的场景）

- OverlayFS 支持跨容器共享页缓存：多个容器访问同一镜像文件时，内核仅缓存一份数据，降低内存占用。AUFS 无此优化，每个容器需独立缓存相同文件

📈 4.社区生态

- 自 Docker 版本 1.12 起，OverlayFS 成为默认存储驱动，官方持续优化其稳定性与功能

- Linux 内核社区放弃 AUFS 维护，新特性（如 ID 映射、安全增强）仅适配 OverlayFS

### OverlayFS

OverlayFS（Overlay File System）是 Linux 内核中的一种联合挂载文件系统，通过将多个目录（层）透明叠加为单一视图，实现高效的分层存储管理。OverlayFS 使用四个目录来实现分层联合：

- lowerdir（只读层）

  - 可包含多个目录（如 Docker 镜像层）
  - 文件不可修改，多个容器可共享同一组 lowerdir

- upperdir（读写层）

  - 存储用户修改后的内容（如容器运行时的文件内容变更）
  - 文件修改或删除时，通过写时复制（CoW）将数据从 lowerdir 复制到 upperdir 再操作

- workdir（工作目录）

  - ​​ 内部临时目录，用于原子化操作（如文件复制），挂载后内容自动清空且用户不可见

- merged（合并目录）

  - 用户访问的最终目录，动态合并 lowerdir 和 upperdir 内容

整体架构如下图所示：

![Docker](/docker/core/cow-dir.png)

#### 文件操作

下面通过命令行模拟测试 OverlayFS 的挂载和修改：

```bash

```

## Docker 文件存储
